def compression

;total_distance = distance_ctest

loading_wall = find_wall(5)
;loading_distance = final_strain*box_height1*2
loading_speed = w_zvel( loading_wall )

cycle_each = 2

;newball_start_id = total_ball_sample+1
;end_disp = final_strain*(abs(box_height1)+abs(box_height2)-total_distance)   ;from 15mm
above_top_platen = abs(box_height1-box_height2)-total_distance-exp_sample_height
end_disp = abs(box_height1-box_height2)-total_distance-exp_sample_height + final_strain*exp_sample_height	;from contact_test
compression_flag = 0
compression_disp = 0.0
cycle_count = 0

loop while compression_flag # 1
	cycle_count = cycle_count + 1
	;contact_test
	;total_distance = total_distance + distance_ctest

	command	
		Wall property zv  loading_speed  range id = 5
	endcommand	
	loop temp_i (1, cycle_each )
		command	
			cycle 1
		endcommand
		compression_disp = compression_disp + abs( loading_speed )* tdel
		total_distance = total_distance + abs( loading_speed )* tdel

	endloop

	;ball_number
	breakage_check


	command
		Wall property zv 0.0  range id = 5
		cycle 100 ;calm 2
		;save middle.sav
	endcommand
	;selective_cycle
	;pb_bond_reactivate	;reactiveate pbond
	;clump_release_pb_activate

	if compression_disp > end_disp 
		compression_flag = 1 
		
	end_if
	
	iii = find_wall(5)
	kkk = abs(w_zfob(iii))
	compressive_force(cycle_count) =string(kkk)

	lll = abs(box_height1)+abs(box_height2)-total_distance
	sample_height(cycle_count) = string( lll )

	mmm = breakage_events
	s_breakage_events(cycle_count) = string( mmm )
	
	nnn = pbbreak_count_ii
	s_breakage_events2(cycle_count) =string( nnn )
	
	
	
endloop
status=open('breakage_xpos.txt', 1, 1)
status=write(xbreakage , breakage_events )
status=close

status=open('breakage_ypos.txt', 1, 1)
status=write(ybreakage , breakage_events )
status=close

status=open('breakage_zpos.txt', 1, 1)
status=write(zbreakage , breakage_events )
status=close

iii = cycle_count-1
status=open('compressive_force.txt', 1, 1)
status=write(compressive_force , iii )
status=close

status=open('sample_height.txt', 1, 1)
status=write(sample_height , iii )
status=close

status=open('breakage_events.txt', 1, 1)
status=write(s_breakage_events, iii )
status=close


status=open('breakage_events2.txt', 1, 1)
status=write(s_breakage_events2, iii )
status=close


end